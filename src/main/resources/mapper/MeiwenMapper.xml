<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aguang.jinjuback.dao.MeiwenDao">

    <!-- 创建金句 -->
    <insert id="createMeiwen">
        INSERT INTO
          jinju_db.meiwen(user_id,title,type,summary,cover_img_url,content,browse_count,collect_count,comment_count,is_delete,create_time,update_time)
        VALUES(#{userId},#{title},#{type},#{summary},#{coverImgUrl},#{content},
              #{browseCount},#{collectCount},#{commentCount},#{isDelete},#{createTime},#{updateTime});
    </insert>

    <!-- 获取美文的列表信息（用户已登录的情况） -->
    <select id="listByPageWithUserId" resultType="com.aguang.jinjuback.model.pojo.MeiwenInfo">
        SELECT
            m.id as meiwenId,
            m.type,
            m.title,
            m.summary,
            m.cover_img_url,
            m.browse_count,
            m.collect_count,
            c.collect as is_collect,
            m.comment_count,
            m.create_time,
            m.update_time,
            u.user_id,
            u.username,
            u.photo_url
        FROM
          meiwen m
        LEFT JOIN jj_user u ON m.user_id = u.user_id
        LEFT JOIN mw_collect c ON m.id = c.meiwen_id
        AND c.user_id = #{userId}
        order by m.create_time desc

        LIMIT #{m},#{n}
    </select>

    <!-- 获取美文的列表信息（用户未登录的情况） -->
    <select id="listByPageWithoutUserId" resultType="com.aguang.jinjuback.model.pojo.MeiwenInfo">
        SELECT
            m.id as meiwenId,
            m.type,
            m.title,
            m.summary,
            m.cover_img_url,
            m.browse_count,
            m.collect_count,
            m.comment_count,
            m.create_time,
            m.update_time,
            u.user_id,
            u.username,
            u.photo_url
        FROM
          meiwen m
        LEFT JOIN jj_user u ON m.user_id = u.user_id
        order by m.create_time desc

        LIMIT #{m},#{n}
    </select>

    <!-- 获取美文的详情信息 -->
    <select id="getMeiwen" resultType="com.aguang.jinjuback.model.pojo.MeiwenInfo">
        SELECT
            m.id as meiwenId,
            m.type,
            m.title,
            m.summary,
            m.cover_img_url,
            m.content,
            m.browse_count,
            m.collect_count,
        <if test="userId != null">
            c.collect as is_collect,
        </if>
            m.comment_count,
            m.create_time,
            m.update_time,
            u.user_id,
            u.username,
            u.photo_url
        FROM
            meiwen m
        LEFT JOIN jj_user u ON m.user_id = u.user_id
        <if test="userId != null">
            LEFT JOIN mw_collect c ON m.id = c.meiwen_id
            AND c.user_id = #{userId}
        </if>
        WHERE m.id = #{id}

        order by m.create_time desc
    </select>

    <!-- 创建美文评论 -->
    <insert id="createMeiwenComment">
        INSERT INTO jinju_db.mw_comment(meiwen_id,user_id,content,create_time)
        VALUES(#{meiwenId},#{userId},#{content},#{createTime});
    </insert>

    <!-- 获取评论列表 -->
    <select id="listMeiwenCommentByPage" resultType="com.aguang.jinjuback.model.pojo.MeiwenCommentInfo">
        SELECT
            m.id,
            m.meiwen_id,
            m.content,
            m.create_time,
            u.user_id,
            u.username,
            u.photo_url
        FROM
          mw_comment m
        LEFT JOIN jj_user u ON m.user_id = u.user_id
        WHERE m.meiwen_id = #{meiwenId}

        order by m.create_time desc

        LIMIT #{m},#{n}
    </select>

</mapper>